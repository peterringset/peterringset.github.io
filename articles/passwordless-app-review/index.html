<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="Peter Ringset"/><link rel="canonical" href="https://peterringset.dev/articles/passwordless-app-review"/><meta name="twitter:url" content="https://peterringset.dev/articles/passwordless-app-review"/><meta name="og:url" content="https://peterringset.dev/articles/passwordless-app-review"/><title>Getting Your iOS App with Passwordless Sign in Approved by App Review | Peter Ringset</title><meta name="twitter:title" content="Getting Your iOS App with Passwordless Sign in Approved by App Review | Peter Ringset"/><meta name="og:title" content="Getting Your iOS App with Passwordless Sign in Approved by App Review | Peter Ringset"/><meta name="description" content="See how you can set up a simple system to get an app using passwordless sign in approved by app review."/><meta name="twitter:description" content="See how you can set up a simple system to get an app using passwordless sign in approved by app review."/><meta name="og:description" content="See how you can set up a simple system to get an app using passwordless sign in approved by app review."/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Peter Ringset"/></head><body class="item-page"><header><div class="wrapper"><nav><a href="/" class="site-name">Peter Ringset</a><ul><li><a href="/articles" class="selected">Posts</a></li><li><a href="/about">About me</a></li></ul></nav></div></header><div class="wrapper"><article><h1>Getting Your iOS App with Passwordless Sign in Approved by App Review</h1><p class="date">15 Jan 2021</p><ul class="tag-list"><li><a href="/tags/vapor">Vapor</a></li></ul><div class="content"><p>Apple’s app review will often require you to provide <a href="https://developer.apple.com/app-store/review/guidelines/#before-you-submit">login credentials</a> to a test account so that the reviewers can access all features in your app. Lately, the so-called passwordless type of login has become more and more common, especially since Apple has started catering more for auto-filling one time passwords (OTPs) sent via SMS. This can, however, lead to some headaches when submitting your app for review, and in the worst case may lead your submission to be rejected. This article will describe making a web app that can let Apple reviewers log in to your app using a passwordless SMS setup. We will use <a href="https://www.twilio.com">Twilio</a> as our SMS provider, and implement our app with <a href="https://vapor.codes">Vapor</a> and deploy it to <a href="https://dashboard.heroku.com">Heroku</a>.</p><p>If you’re mainly interested in trying this out for yourself you can head over to the <a href="https://github.com/peterringset/passwordless-login">GitHub repository</a>, where you will find what you need to get quickly up and running.</p><h2>Prerequisites</h2><p>This article is based on using Twilio for sending out SMS OTPs, but you can probably make some adjustments to make this work with almost any SMS service. This article will not cover any of the initial setup for the passwordless login, there are plenty of other guides for that out there. From this point on we will assume that your app has a working login mechanism that somehow uses Twilio for sending out OTPs.</p><p>The main idea behind this solution is to leave as much as possible of your existing application and infrastructure untouched. It is always risky to introduce special cases and backdoors into your application, and so we’re striving to leave all the application code completely untouched when allowing Apple’s reviewers to log in to a test account. To achieve this we require that there is a phone number that reviewers can log in with. You can try to purchase a number with Twilio, or you can use your own, it really doesn’t matter as long as it’s a phone number that you can try to send a message to.</p><p>We will instruct the reviewers to log in to your app normally, inputting the provided phone number and then being led to a screen where they’re supposed to input the OTP sent by SMS. At this point, you’re probably wondering how to make sure that the reviewers can log in with a valid OTP. In most applications, this OTP is a randomly generated number and is only valid for a couple of minutes, so that means that we’re reliant on using some sort of automated mechanism for providing this OTP to the reviewers.</p><h2>The Broad Strokes</h2><p>We’re basing our solution on <a href="https://www.twilio.com/docs/sms/tutorials/how-to-retrieve-and-modify-message-history">Twilio’s message history API</a>. This API lets us query what has been sent (or tried to be sent) from the message service we’ve set up. For our needs, we can query this API and get back the latest message sent to a specific number and display that on a website. This means that there are no special cases in our app or backend code to handle the login to the test account, everything works as normal. The only thing needed to make this setup work is a small web-application that can fetch the message containing the OTP and display it on a website.</p><h2>The Web App</h2><p>Twilio’s message history API has SDKs for many different languages, but since this is an article written mainly for Swift developers I’ve decided to write this web app in Swift, using <a href="https://vapor.codes">Vapor</a> as the server-side framework. If you haven’t used Vapor before I suggest you go to their website and <a href="https://docs.vapor.codes/4.0/install/macos/">install Vapor</a> before you come back here and read on.</p><p>To get started we will first create the skeleton of our Vapor application:</p><pre><code>vapor new passwordless-login --no-fluent --leaf
</code></pre><p>This sets up a brand new Vapor server application that uses Leaf (Vapor’s templating language). Open the <code>Package.swift</code> file with Xcode to get started adding functionality to our app.</p><p>To begin with, we will add a file to make sure that the project compiles on Linux.</p><pre><code>cd passwordless-login/  
touch <span class="pre code type">Tests</span>/<span class="pre code type">LinuxMain</span>.<span class="pre code property">swift</span>  
git commit --amend --no-edit
</code></pre><h2>Getting Data from Twilio</h2><p>Messages from Twilio comes to us as JSON, and we need to create a model for this. Put this file in <code>Sources/App/Models/Message.swift</code></p><p>Then we’ll implement a networking client that can fetch data from Twilio. To match the recommended structure of a Vapor project we’ll use the protocol name <code>TwilioRepository</code>, and make an implementation <code>TwilioAPIRepository</code> that fetches messages over the network. This file is put in <code>Sources/App/Repositories/TwilioRepository.swift</code>. We will start by adding a skeleton of the repository.</p><p>This skeleton sets up the URI with query parameters that ensure we only get one message for the specified phone number. It also specifies the <code>Authorization</code> header so we can authenticate with the Twilio API. Now we can modify the <code>latestMessage()</code> function to make the network call and deserialize the response into our <code>Message</code> type.</p><p>We also need to create a file for the type <code>TwilioConfig</code>. Put this file together with the message model, in <code>Sources/App/Models/TwilioConfig.swift</code></p><p>Note that we’re adding an extension to instantiate this struct from the environment since we don’t want to check in any identifiers, auth tokens or hard code any phone numbers.</p><p>Let’s commit these changes.</p><pre><code>git add .  
git commit -m <span class="pre code string">"Add repository for Twilio messages"</span>
</code></pre><p>With this in place, we can proceed to set up a simple page that displays this info.</p><h2>Setting up the Main Page</h2><p>Start by adding a file in <code>Sources/App/Controllers/MessageController.swift</code></p><p>This will render the Leaf file under <code>Resources/Views/index.leaf</code> with the provided data. Note that we're also filtering out the message if it's older than 120 seconds. In our case, this is the validity time of our OTP, but feel free to change this value if needed.</p><p>To wire up this route go to <code>Sources/App/routes.swift</code> and update the <code>routes</code> function.</p><p>We will also have to change <code>Sources/App/configure.swift</code> to pass the Twilio config.</p><p>Then head over to the <code>Resources/Views/index.leaf</code> file and replace its contents with the following:</p><p>You probably aren’t going to win any design awards with this page, but it gets the job done.</p><img src="/images/passwordless-app-review/passwordless.png" alt="The web interface"/><p>To wrap up this step we will commit all our changes.</p><pre><code>git add .  
git commit -m <span class="pre code string">"Add controller and route for fetching latest message"</span>
</code></pre><h2>Authentication</h2><p>We want to protect this web page with authentication. We can make sure that the web page is only live we have a version in review and make sure that it’s only used for test accounts. But ultimately, it’s still a security issue and we should password protect the site to be as secure as we can.</p><p>Vapor has some built-in support for basic authentication, but unfortunately, they have not implemented the part that triggers the username/password prompt in web browsers, so we will roll our own implementation of this. Our implementation is heavily based on <a href="https://github.com/vapor/vapor/issues/2337#issuecomment-740675655">this answer on their GitHub issue</a>.</p><p>We won’t bother with a database or anything like that, since there’s only going to be one set of credentials for this site. So we will be using environment variables for this too. Create a new file in <code>Sources/App/Models/BasicAuthConfig.swift</code>:</p><p>To set up the basic auth itself we will add a new file <code>Sources/App/Middleware/UserAuthentication.swift</code>, and add the following code.</p><p>This actually doesn’t to any authentication yet, this first version only adds a user object to the request object before it is delivered to our controller. To make sure that the authentication is handled correctly we will change the <code>respond(to:chainingTo:)</code>function to do the following:</p><p>To make use of this we will have to modify our routing, change the <code>routes</code> function in <code>Sources/App/routes.swift</code>.</p><p>This will make sure that the middleware adds the appropriate headers whenever a controller tries to access a route protected by authentication. We also use a <code>User.guardMiddleware()</code> that makes sure that there is a <code>User</code> object present in all requests coming to the routes protected by these authenticators.</p><p>Remember to modify the call to the <code>routes</code> function in the <code>Sources/App/configure.swift</code> file.</p><p>Then commit these changes to git.</p><pre><code>git add .  
git commit -m <span class="pre code string">"Add authentication to protect web page with basic auth login"</span>
</code></pre><h2>Running locally</h2><p>You probably want to do local build and run by now. Since we’re using environment variables you need to set those up before running the app. You can do this by adding a <code>.env</code>-file in the root of the repository with the following content.</p><pre><code><span class="pre code type">TWILIO_ACCOUNT_SID</span>=&lt;twilio-account-sid&gt;  
<span class="pre code type">TWILIO_AUTH_TOKEN</span>=&lt;twilio-auth-token&gt;  
<span class="pre code type">TWILIO_TO_NUMBER</span>=&lt;phone-number&gt;  
<span class="pre code type">BASIC_AUTH_REALM</span>=<span class="pre code type">Messages  
BASIC_AUTH_USERNAME</span>=&lt;username&gt;  
<span class="pre code type">BASIC_AUTH_PASSWORD</span>=&lt;password&gt;
</code></pre><p>Make sure to replace the bracketed values with real values for your setup. The identifier and token for Twilio can be found in <a href="https://www.twilio.com/console">their console</a>.</p><h2>Deploying to Heroku</h2><p>There are a few choices for deploying a Vapor application, one of the simplest is through <a href="https://dashboard.heroku.com">Heroku</a>. They have built-in support for running Vapor applications, so there are <a href="https://docs.vapor.codes/3.0/deploy/heroku/">very few steps</a> to get our little web app live. If you don’t have the Heroku CLI installed yet you can start by installing it via <a href="https://brew.sh">Homebrew</a>.</p><pre><code>brew install heroku/brew/heroku
</code></pre><p>Then make sure you are logged in with the CLI.</p><pre><code>heroku login
</code></pre><h3>Set up</h3><p>We need to create a <code>Procfile</code> that describes how to run our application to Heroku, and a <code>.swift-version</code> file that specifies our Swift version. At the time of writing the highest supported version of Swift on Heroku's servers is 5.3.</p><pre><code>echo <span class="pre code string">"web: Run --env production --hostname 0.0.0.0 --port $PORT"</span> &gt; <span class="pre code type">Procfile</span>  
echo <span class="pre code string">"5.3"</span> &gt; .<span class="pre code dotAccess">swift</span>-version
</code></pre><p>Heroku’s deployment process is based on pushing your code to a git remote that they control. Use the Heroku CLI to first create the app in the Heroku system, and then add the Heroku remote to our git repository.</p><pre><code>heroku apps:create &lt;your-application-name&gt; --buildpack vapor/vapor  
heroku git:remote -a &lt;your-application-name&gt;
</code></pre><p>Make sure to replace <code>&lt;your-application-name&gt;</code> with a real application name.</p><h3>Environment</h3><p>Since we’re using environment variables (or config vars in Heroku’s terms) in our application we need to make sure that they’re set up in Heroku’s system. We will do this by using the CLI:</p><pre><code>heroku config:<span class="pre code keyword">set</span> \  
 <span class="pre code type">TWILIO_ACCOUNT_SID</span>=&lt;twilio-account-sid&gt; \  
 <span class="pre code type">TWILIO_AUTH_TOKEN</span>=&lt;twilio-auth-token&gt; \  
 <span class="pre code type">TWILIO_TO_NUMBER</span>=&lt;phone-number&gt; \  
 <span class="pre code type">BASIC_AUTH_REALM</span>=<span class="pre code type">Messages</span> \  
 <span class="pre code type">BASIC_AUTH_USERNAME</span>=&lt;username&gt; \  
 <span class="pre code type">BASIC_AUTH_PASSWORD</span>=&lt;password&gt;
</code></pre><h3>Deploying</h3><p>To wrap everything up we will commit our changes and deploy to Heroku.</p><pre><code>git add .  
git commit -m <span class="pre code string">"Add Heroku build files"</span>  
git push heroku master
</code></pre><p>The deployment process is going to take a few minutes of building and getting everything ready.</p><p>If you need to start or stop your app you can run the following commands.</p><pre><code>heroku ps:scale web=<span class="pre code number">0</span> <span class="pre code comment">// stop</span>  
<span class="pre code type">Heroku</span> ps:scale web=<span class="pre code number">1</span> <span class="pre code comment">// start</span>
</code></pre><h2>Wrapping up</h2><p>And with that, you have a live and working web app that can help you get your app approved by app review. The final application lets us keep our app and backend code intact, without having to introduce any back doors or special cases to let reviewers log in. Apart from deploying this web app you also have to make sure that the reviewers can successfully log in using the provided phone number in your system.</p><p>To check out the final source code for this project you can go to the <a href="https://github.com/peterringset/passwordless-login">GitHub repository</a>. You can also <a href="https://twitter.com/PRingset">follow me on Twitter</a>, where I post links to articles that I’m writing.</p></div></article></div><footer><p>Generated using <a href="https://github.com/johnsundell/publish">Publish</a></p><p><a href="https://github.com/peterringset">GitHub</a><span> | </span><a href="https://twitter.com/PRingset">Twitter</a><span> | </span><a href="/feed.rss">RSS</a></p></footer></body></html>